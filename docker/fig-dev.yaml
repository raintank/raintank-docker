version: '2'

services:
  elasticsearch:
    image: library/elasticsearch:latest
    hostname: elasticsearch
    ports:
      - "9200:9200"
      - "9300"
    volumes:
      - /data

  rabbitmq:
    image: raintank/rabbitmq
    hostname: rabbitmq
    ports:
      - "5672"
      - "15672:15672"

  kafka:
    image: raintank/kafka
    hostname: kafka
    environment:
      ADVERTISED_HOST: kafka
    ports:
      - "2181:2181"
      - "9092:9092"
      - "9999:9999"
    volumes:
      - /tmp/kafka-logs
      - ../logs/zookeeper:/var/log/zookeeper
      - ../logs/supervisor:/var/log/supervisor

  kafkaManager:
    image: sheepkiller/kafka-manager
    hostname: kafka-manager
    environment:
            ZK_HOSTS: kafka:2181
            APPLICATION_SECRET: somesalt
    ports:
      - "9000:9000"

  kafkaOffsetMonitor:
    image: jpodeszwik/kafka-offset-monitor:0.2.1
    hostname: kafka-offset-monitor
    environment:
            ZK: kafka
    ports:
      - "8080:8080"

  graphitewatcher:
    image: raintank/graphitewatcher
    hostname: watcher
    ports:
      - "6065:6065"
    links:
      - graphiteMetrictank:graphite-api
    volumes:
      - ../logs:/var/log/raintank
      - ../raintank_code/inspect:/go/src/github.com/raintank/inspect

  metrictank0:
    image: raintank/metrictank
    hostname: metrictank0
    ports:
      - "6070:6063"
    volumes:
      - ../logs:/var/log/raintank
      - ./metrictank:/etc/raintank
      - ../raintank_code/metrictank/build/metrictank:/usr/bin/metrictank
    environment:
      WAIT_HOSTS: kafka:9092,elasticsearch:9200,cassandra:9042
      WAIT_TIMEOUT: 30
      MT_KAFKA_MDM_IN_PARTITIONS : 0,1
      MT_CASSANDRA_INITIALIZE : "true"
      MT_LOG_LEVEL: 2
      MT_OTHER_NODES: metrictank1:6063,metrictank2:6063,metrictank3:6063,metrictank4:6063,metrictank5:6063,metrictank6:6063,metrictank7:6063

  metrictank1:
    image: raintank/metrictank
    hostname: metrictank1
    ports:
      - "6071:6063"
    volumes:
      - ../logs:/var/log/raintank
      - ./metrictank:/etc/raintank
      - ../raintank_code/metrictank/build/metrictank:/usr/bin/metrictank
    environment:
      WAIT_HOSTS: kafka:9092,elasticsearch:9200,cassandra:9042
      WAIT_TIMEOUT: 30
      MT_KAFKA_MDM_IN_PARTITIONS : 2,3
      MT_LOG_LEVEL: 2
      MT_OTHER_NODES: metrictank0:6063,metrictank2:6063,metrictank3:6063,metrictank4:6063,metrictank5:6063,metrictank6:6063,metrictank7:6063

  metrictank2:
    image: raintank/metrictank
    hostname: metrictank2
    ports:
      - "6072:6063"
    volumes:
      - ../logs:/var/log/raintank
      - ./metrictank:/etc/raintank
      - ../raintank_code/metrictank/build/metrictank:/usr/bin/metrictank
    environment:
      WAIT_HOSTS: kafka:9092,elasticsearch:9200,cassandra:9042
      WAIT_TIMEOUT: 30
      MT_KAFKA_MDM_IN_PARTITIONS : 4,5
      MT_OTHER_NODES: metrictank0:6063,metrictank1:6063,metrictank3:6063,metrictank4:6063,metrictank5:6063,metrictank6:6063,metrictank7:6063

  metrictank3:
    image: raintank/metrictank
    hostname: metrictank3
    ports:
      - "6073:6063"
    volumes:
      - ../logs:/var/log/raintank
      - ./metrictank:/etc/raintank
      - ../raintank_code/metrictank/build/metrictank:/usr/bin/metrictank
    environment:
      WAIT_HOSTS: kafka:9092,elasticsearch:9200,cassandra:9042
      WAIT_TIMEOUT: 30
      MT_KAFKA_MDM_IN_PARTITIONS : 6,7
      MT_OTHER_NODES: metrictank0:6063,metrictank1:6063,metrictank2:6063,metrictank4:6063,metrictank5:6063,metrictank6:6063,metrictank7:6063

  metrictank4:
    image: raintank/metrictank
    hostname: metrictank4
    ports:
      - "6074:6063"
    volumes:
      - ../logs:/var/log/raintank
      - ./metrictank:/etc/raintank
      - ../raintank_code/metrictank/build/metrictank:/usr/bin/metrictank
    environment:
      WAIT_HOSTS: kafka:9092,elasticsearch:9200,cassandra:9042
      WAIT_TIMEOUT: 30
      MT_KAFKA_MDM_IN_PARTITIONS : 8,9
      MT_OTHER_NODES: metrictank0:6063,metrictank1:6063,metrictank2:6063,metrictank3:6063,metrictank5:6063,metrictank6:6063,metrictank7:6063

  metrictank5:
    image: raintank/metrictank
    hostname: metrictank5
    ports:
      - "6075:6063"
    volumes:
      - ../logs:/var/log/raintank
      - ./metrictank:/etc/raintank
      - ../raintank_code/metrictank/build/metrictank:/usr/bin/metrictank
    environment:
      WAIT_HOSTS: kafka:9092,elasticsearch:9200,cassandra:9042
      WAIT_TIMEOUT: 30
      MT_KAFKA_MDM_IN_PARTITIONS : 10,11
      MT_OTHER_NODES: metrictank0:6063,metrictank1:6063,metrictank2:6063,metrictank3:6063,metrictank4:6063,metrictank6:6063,metrictank7:6063

  metrictank6:
    image: raintank/metrictank
    hostname: metrictank6
    ports:
      - "6076:6063"
    volumes:
      - ../logs:/var/log/raintank
      - ./metrictank:/etc/raintank
      - ../raintank_code/metrictank/build/metrictank:/usr/bin/metrictank
    environment:
      WAIT_HOSTS: kafka:9092,elasticsearch:9200,cassandra:9042
      WAIT_TIMEOUT: 30
      MT_KAFKA_MDM_IN_PARTITIONS : 12,13
      MT_OTHER_NODES: metrictank0:6063,metrictank1:6063,metrictank2:6063,metrictank3:6063,metrictank4:6063,metrictank5:6063,metrictank7:6063

  metrictank7:
    image: raintank/metrictank
    hostname: metrictank7
    ports:
      - "6077:6063"
    volumes:
      - ../logs:/var/log/raintank
      - ./metrictank:/etc/raintank
      - ../raintank_code/metrictank/build/metrictank:/usr/bin/metrictank
    environment:
      WAIT_HOSTS: kafka:9092,elasticsearch:9200,cassandra:9042
      WAIT_TIMEOUT: 30
      MT_KAFKA_MDM_IN_PARTITIONS : 14,15
      MT_OTHER_NODES: metrictank0:6063,metrictank1:6063,metrictank2:6063,metrictank3:6063,metrictank4:6063,metrictank5:6063,metrictank6:6063

  eventtank:
    image: raintank/eventtank
    hostname: npee
    ports:
      - "6062:6060"
    environment:
            WAIT_HOSTS: kafka:9092,elasticsearch:9200,statsdaemon:8125
    volumes:
      - ../raintank_code/eventtank/build:/go/bin/

  graphitemon:
    image:  raintank/graphite
    hostname: graphitemon
    ports:
      - "2003:2003"
      - "8000:80"

  cassandra:
    image: cassandra:3.0.8
    hostname: cassandra
    ports:
      - "9042"
      - "9160"
      - "8888"

  mysql:
    image: mysql
    hostname: mysql
    ports:
      - "3306"
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: grafana
      MYSQL_USER: grafana
      MYSQL_PASSWORD: password
    volumes:
      - /var/lib/mysql

  graphiteMetrictank:
    image: raintank/graphite-metrictank
    hostname: graphite
    ports:
      - "8888:8888"
    environment:
      WAIT_HOSTS: elasticsearch:9200,metrictank0:6063
    volumes:
      - ../logs:/var/log/raintank
      - ./graphite-metrictank/graphite-metrictank.yaml:/etc/graphite-metrictank/graphite-metrictank.yaml

  worldpingApi:
    image: raintank/worldping-api
    hostname: worldping-api
    ports:
      - "80:80"
    links:
      - graphiteMetrictank:graphite-api
    depends_on:
      - mysql
    environment:
      WAIT_HOSTS: kafka:9092,mysql:3306,rabbitmq:5672
      WAIT_TIMEOUT: 30
    volumes:
      - ./worldping-api/:/etc/raintank/

  statsdaemon:
    image: raintank/statsdaemon
    hostname: statsdaemon
    ports:
      - "8126:8126"

  benchmark:
    image: raintank/benchmark
    hostname: benchmark
    volumes:
      - ../raintank_code/inspect:/go/src/github.com/raintank/inspect
      - ../raintank_code/fakemetrics:/go/src/github.com/raintank/fakemetrics
      - ../logs:/var/log/raintank
      - ../results:/opt/raintank/raintank-tsdb-benchmark/results
    ports:
      - "6764:6764"
    links:
      - graphiteMetrictank:graphite-api

  grafana:
    image: raintank/grafana
    hostname: grafana
    ports:
      - "3000:3000"
    links:
      - metrictank0:metrictank
      - proxy:tsdb-gw.raintank.io
      - proxy:worldping-api.raintank.io
    volumes:
      - ../raintank_code/plugins:/var/lib/grafana/plugins
      - ../logs:/var/log/raintank

  taskAgent:
    image: raintank/task-agent
    hostname: task-agent
    ports:
      - "8181:8181"
    links:
      - taskServer:task-server
    volumes:
      - ../raintank_code/raintank-apps/build/bin:/go/bin
      - ../raintank_code/raintank-apps/build/plugins:/var/lib/snap/plugins
      - ../logs:/var/log/raintank

  taskServer:
    image: raintank/task-server
    hostname: task-server
    ports:
      - "8082:80"
    environment:
      WAIT_HOSTS: rabbitmq:5672
    volumes:
      - ../raintank_code/raintank-apps/build/bin:/go/bin

  tsdbgw:
    image: raintank/tsdb-gw
    hostname: tsdb-gw.raintank.io
    ports:
      - "8081:80"
    links:
      - graphiteMetrictank:graphite-api
    environment:
      WAIT_HOSTS: kafka:9092
    volumes:
      - ./tsdb-gw/:/etc/raintank/

  carbon-relay-ng:
    image: raintank/carbon-relay-ng
    hostname: carbon-relay-ng
    ports:
      - "8083:8083"
      - "2013:2013"
    depends_on:
            - graphitemon
    volumes:
      - ../raintank_code/carbon-relay-ng:/go/src/github.com/graphite-ng/carbon-relay-ng
      - ../logs:/var/log/raintank
    
  collectd:
    image: raintank/collectd
    hostname: collectd

  proxy:
    image: raintank/proxy
    hostname: proxy
    ports:
      - "443:443"
    links:
      - tsdbgw:tsdb-gw
      - worldpingApi:worldping-api

